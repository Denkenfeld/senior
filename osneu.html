<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vita OS - Pflegeabrechnung</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary: #00A499;
      --primary-dark: #008C83;
      --secondary: #FF6B6B;
      --success: #51CF66;
      --warning: #FFA94D;
      --bg: #F8F9FA;
      --surface: #FFFFFF;
      --text: #212529;
      --text-muted: #6C757D;
      --border: #DEE2E6;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding-bottom: env(safe-area-inset-bottom);
      overflow-x: hidden;
    }
    
    /* Header */
    .header {
      position: sticky;
      top: 0;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .header h1 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--primary);
    }
    
    .header-actions {
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }
    
    .header-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem;
    }
    
    /* Main Content */
    .main-content {
      padding: 1rem;
      padding-bottom: 80px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      padding: 0.5rem;
      padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
      z-index: 100;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
      color: var(--text-muted);
      padding: 0.5rem;
      border-radius: 0.5rem;
      transition: all 0.2s;
      flex: 1;
      max-width: 80px;
    }
    
    .nav-item.active {
      color: var(--primary);
      background: rgba(0, 164, 153, 0.1);
    }
    
    .nav-item .icon {
      font-size: 1.5rem;
      margin-bottom: 0.25rem;
    }
    
    .nav-item .label {
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    /* Cards */
    .card {
      background: var(--surface);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      border: 1px solid var(--border);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    
    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
    }
    
    .card-subtitle {
      color: var(--text-muted);
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }
    
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      min-height: 44px;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:active {
      background: var(--primary-dark);
      transform: scale(0.98);
    }
    
    .btn-secondary {
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-block {
      width: 100%;
    }
    
    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      min-height: 36px;
    }
    
    /* Badge */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .badge-success {
      background: rgba(81, 207, 102, 0.1);
      color: var(--success);
    }
    
    .badge-warning {
      background: rgba(255, 169, 77, 0.1);
      color: var(--warning);
    }
    
    .badge-primary {
      background: rgba(0, 164, 153, 0.1);
      color: var(--primary);
    }
    
    /* List Items */
    .list-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      background: var(--surface);
      border-radius: 8px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid var(--border);
    }
    
    .list-item:active {
      background: var(--bg);
      transform: scale(0.99);
    }
    
    .list-item-icon {
      font-size: 2rem;
      margin-right: 1rem;
    }
    
    .list-item-content {
      flex: 1;
    }
    
    .list-item-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    .list-item-subtitle {
      color: var(--text-muted);
      font-size: 0.875rem;
    }
    
    .list-item-action {
      color: var(--text-muted);
      font-size: 1.5rem;
    }
    
    /* Forms */
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text);
    }
    
    .form-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      background: var(--surface);
      min-height: 44px;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: flex-end;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: var(--surface);
      border-radius: 16px 16px 0 0;
      padding: 1.5rem;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
    }
    
    /* Signature Pad */
    .signature-pad {
      border: 2px dashed var(--border);
      border-radius: 8px;
      margin: 1rem 0;
      position: relative;
      background: var(--bg);
    }
    
    .signature-canvas {
      display: block;
      width: 100%;
      height: 200px;
      cursor: crosshair;
    }
    
    /* Login Screen */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    }
    
    .login-box {
      background: var(--surface);
      padding: 2rem;
      border-radius: 16px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }
    
    .login-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .login-logo {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    
    .login-title {
      font-size: 1.5rem;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }
    
    .demo-users {
      background: var(--bg);
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      font-size: 0.75rem;
    }
    
    .demo-users strong {
      display: block;
      margin-bottom: 0.5rem;
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .stat-card {
      background: var(--surface);
      padding: 1rem;
      border-radius: 12px;
      text-align: center;
      border: 1px solid var(--border);
    }
    
    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.25rem;
    }
    
    .stat-label {
      font-size: 0.875rem;
      color: var(--text-muted);
    }
    
    .stat-change {
      font-size: 0.75rem;
      margin-top: 0.25rem;
    }
    
    .stat-change.up {
      color: var(--success);
    }
    
    /* Hide on Desktop */
    @media (min-width: 768px) {
      .main-content {
        padding-bottom: 2rem;
      }
      
      .bottom-nav {
        display: none;
      }
      
      body {
        display: flex;
      }
      
      .desktop-sidebar {
        display: block !important;
        width: 240px;
        background: var(--surface);
        border-right: 1px solid var(--border);
        height: 100vh;
        position: sticky;
        top: 0;
      }
      
      .desktop-content {
        flex: 1;
        overflow-y: auto;
      }
    }
    
    .desktop-sidebar {
      display: none;
    }
    
    .sidebar-nav {
      padding: 1rem;
    }
    
    .sidebar-item {
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      border-radius: 8px;
      text-decoration: none;
      color: var(--text);
      transition: all 0.2s;
    }
    
    .sidebar-item:hover,
    .sidebar-item.active {
      background: rgba(0, 164, 153, 0.1);
      color: var(--primary);
    }
    
    .sidebar-item .icon {
      font-size: 1.25rem;
      margin-right: 0.75rem;
    }
    
    /* Utils */
    .hidden {
      display: none !important;
    }
    
    .text-center {
      text-align: center;
    }
    
    .text-muted {
      color: var(--text-muted);
    }
    
    .mb-1 {
      margin-bottom: 1rem;
    }
    
    .mt-1 {
      margin-top: 1rem;
    }
    
    .greeting {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .date-display {
      color: var(--text-muted);
      margin-bottom: 1.5rem;
    }
    
    .section-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.75rem;
    }
    
    .active-visit-card {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
    }
    
    .active-visit-card .card-title,
    .active-visit-card .card-subtitle {
      color: white;
    }
    
    .leistung-item {
      background: var(--bg);
      padding: 0.75rem;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .leistung-info {
      flex: 1;
    }
    
    .leistung-title {
      font-weight: 500;
      margin-bottom: 0.25rem;
    }
    
    .leistung-details {
      font-size: 0.875rem;
      color: var(--text-muted);
    }
    
    .leistung-price {
      font-weight: 600;
      color: var(--primary);
    }
  </style>
</head>
<body>
  
  <!-- Login Screen -->
  <div id="login-screen" class="login-container">
    <div class="login-box">
      <div class="login-header">
        <div class="login-logo">üè•</div>
        <h1 class="login-title">VITA OS</h1>
        <p class="text-muted">Pflegeabrechnung</p>
      </div>
      
      <form id="login-form">
        <div class="form-group">
          <label class="form-label">E-Mail</label>
          <input type="email" class="form-input" id="login-email" placeholder="E-Mail eingeben" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Passwort</label>
          <input type="password" class="form-input" id="login-password" placeholder="Passwort eingeben" required>
        </div>
        
        <button type="submit" class="btn btn-primary btn-block">Anmelden</button>
      </form>
      
      <div class="demo-users">
        <strong>üéÆ Demo-Zug√§nge:</strong>
        <div>üëî Chef: chef@vitakreis.de / admin123</div>
        <div>üë©‚Äç‚öïÔ∏è Sarah: sarah@vitakreis.de / pfleger123</div>
        <div>üë®‚Äç‚öïÔ∏è Thomas: thomas@vitakreis.de / pfleger123</div>
        <div>üë©‚Äç‚öïÔ∏è Lisa: lisa@vitakreis.de / pfleger123</div>
      </div>
    </div>
  </div>
  
  <!-- Main App -->
  <div id="main-app" class="hidden">
    
    <!-- Desktop Sidebar -->
    <div class="desktop-sidebar">
      <div style="padding: 1.5rem; border-bottom: 1px solid var(--border);">
        <h2 style="color: var(--primary); font-size: 1.5rem;">VITA OS</h2>
      </div>
      <div id="desktop-nav" class="sidebar-nav"></div>
    </div>
    
    <div class="desktop-content">
      <!-- Header -->
      <div class="header">
        <h1>Vita OS</h1>
        <div class="header-actions">
          <button class="header-btn" onclick="showNotifications()">üîî</button>
          <button class="header-btn" onclick="logout()">üö™</button>
        </div>
      </div>
      
      <!-- Content Area -->
      <div class="main-content" id="content-area"></div>
      
      <!-- Bottom Navigation -->
      <nav class="bottom-nav" id="bottom-nav"></nav>
    </div>
  </div>
  
  <!-- Modal for Leistung Auswahl -->
  <div id="leistung-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Leistung hinzuf√ºgen</h2>
        <button class="modal-close" onclick="closeModal('leistung-modal')">‚úï</button>
      </div>
      
      <div class="form-group">
        <input type="text" class="form-input" id="leistung-search" placeholder="üîç Leistung suchen...">
      </div>
      
      <div id="leistung-list"></div>
    </div>
  </div>
  
  <!-- Modal for Unterschrift -->
  <div id="signature-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Unterschrift</h2>
        <button class="modal-close" onclick="closeModal('signature-modal')">‚úï</button>
      </div>
      
      <p class="text-muted mb-1">Patient best√§tigt die erbrachten Leistungen</p>
      
      <div class="signature-pad">
        <canvas id="signature-canvas" class="signature-canvas"></canvas>
      </div>
      
      <div style="display: flex; gap: 0.5rem;">
        <button class="btn btn-secondary" onclick="clearSignature()">üîÑ Neu</button>
        <button class="btn btn-success" style="flex: 1;" onclick="saveSignature()">‚úì Speichern</button>
      </div>
    </div>
  </div>

  <script>
    // ==================== DEMO DATA ====================
    
    const DEMO_USERS = [
      { 
        id: 1, 
        email: 'chef@vitakreis.de', 
        password: 'admin123', 
        name: 'Max Weber', 
        role: 'admin',
        beschaeftigungsnummer: '999000111'
      },
      { 
        id: 2, 
        email: 'sarah@vitakreis.de', 
        password: 'pfleger123', 
        name: 'Sarah Schmidt', 
        role: 'pfleger',
        beschaeftigungsnummer: '303001010'
      },
      { 
        id: 3, 
        email: 'thomas@vitakreis.de', 
        password: 'pfleger123', 
        name: 'Thomas M√ºller', 
        role: 'pfleger',
        beschaeftigungsnummer: '545435435'
      },
      { 
        id: 4, 
        email: 'lisa@vitakreis.de', 
        password: 'pfleger123', 
        name: 'Lisa Wagner', 
        role: 'pfleger',
        beschaeftigungsnummer: '123456789'
      }
    ];
    
    const DEMO_PATIENTEN = [
      { id: 1, vorname: 'Maria', nachname: 'M√ºller', pflegegrad: 'PG2', versichertennummer: 'P145435243', iknr: '184940005', kassenname: 'BARMER', strasse: 'Hauptstr. 12', plz: '72379', stadt: 'Hechingen' },
      { id: 2, vorname: 'Hans', nachname: 'Schmidt', pflegegrad: 'PG3', versichertennummer: 'I454654165', iknr: '185830016', kassenname: 'DAK-Gesundheit', strasse: 'Bahnhofstr. 45', plz: '72379', stadt: 'Hechingen' },
      { id: 3, vorname: 'Anna', nachname: 'Weber', pflegegrad: 'PG2', versichertennummer: 'A123456780', iknr: '184212505', kassenname: 'AOK', strasse: 'Kirchweg 8', plz: '72379', stadt: 'Hechingen' },
      { id: 4, vorname: 'Klaus', nachname: 'Meier', pflegegrad: 'PG1', versichertennummer: 'K789012345', iknr: '188433248', kassenname: 'Siemens BKK', strasse: 'Gartenstr. 23', plz: '72379', stadt: 'Hechingen' },
      { id: 5, vorname: 'Helga', nachname: 'Fischer', pflegegrad: 'PG4', versichertennummer: 'H456789012', iknr: '184940005', kassenname: 'BARMER', strasse: 'Ringstr. 56', plz: '72379', stadt: 'Hechingen' },
      { id: 6, vorname: 'Werner', nachname: 'Bauer', pflegegrad: 'PG2', versichertennummer: 'W234567890', iknr: '185830016', kassenname: 'DAK-Gesundheit', strasse: 'Feldweg 34', plz: '72379', stadt: 'Hechingen' },
      { id: 7, vorname: 'Gertrud', nachname: 'Schulz', pflegegrad: 'PG3', versichertennummer: 'G345678901', iknr: '184940005', kassenname: 'BARMER', strasse: 'Bergstr. 67', plz: '72379', stadt: 'Hechingen' },
      { id: 8, vorname: 'Otto', nachname: 'Koch', pflegegrad: 'PG2', versichertennummer: 'O567890123', iknr: '184212505', kassenname: 'AOK', strasse: 'Talweg 89', plz: '72379', stadt: 'Hechingen' },
      { id: 9, vorname: 'Ingrid', nachname: 'Hoffmann', pflegegrad: 'PG1', versichertennummer: 'I678901234', iknr: '185830016', kassenname: 'DAK-Gesundheit', strasse: 'Waldstr. 12', plz: '72379', stadt: 'Hechingen' },
      { id: 10, vorname: 'Fritz', nachname: 'Zimmermann', pflegegrad: 'PG3', versichertennummer: 'F890123456', iknr: '188433248', kassenname: 'Siemens BKK', strasse: 'Wiesenweg 45', plz: '72379', stadt: 'Hechingen' }
    ];
    
    const LEISTUNGSKATALOG = [
      { id: '01010001', bezeichnung: 'Ganzwaschung', kategorie: 'K√∂rperpflege', betrag: 21.21, punktzahl: 426 },
      { id: '01010002', bezeichnung: 'Teilwaschung', kategorie: 'K√∂rperpflege', betrag: 11.35, punktzahl: 228 },
      { id: '01010008', bezeichnung: 'Mobilisation', kategorie: 'K√∂rperpflege', betrag: 9.31, punktzahl: 187 },
      { id: '01010011', bezeichnung: 'Einkaufen', kategorie: 'Hauswirtschaft', betrag: 7.47, punktzahl: 150 },
      { id: '01010015', bezeichnung: 'Hausbesuchspauschale', kategorie: 'Pauschale', betrag: 1.88, punktzahl: 0 },
      { id: '0101015a', bezeichnung: 'Erh√∂hte Hausbesuchspauschale', kategorie: 'Pauschale', betrag: 4.79, punktzahl: 0 },
      { id: '01010025', bezeichnung: 'Kleine Grundpflege mit Lagern/Betten', kategorie: 'K√∂rperpflege', betrag: 18.07, punktzahl: 363 },
      { id: '01010007', bezeichnung: 'Lagern/Betten', kategorie: 'K√∂rperpflege', betrag: 5.18, punktzahl: 104 },
    ];
    
    // State
    let currentUser = null;
    let currentRoute = 'home';
    let currentBesuch = null;
    let besuchsData = [];
    let signaturePad = null;
    
    // Generate Demo Besuche for current month
    function generateDemoBesuche() {
      const besuche = [];
      const heute = new Date();
      const thisMonth = heute.getMonth();
      const thisYear = heute.getFullYear();
      
      // Generate 30-50 visits for the current month
      for (let i = 0; i < 45; i++) {
        const tag = Math.floor(Math.random() * 28) + 1;
        const datum = new Date(thisYear, thisMonth, tag);
        const patient = DEMO_PATIENTEN[Math.floor(Math.random() * DEMO_PATIENTEN.length)];
        const pfleger = DEMO_USERS.filter(u => u.role === 'pfleger')[Math.floor(Math.random() * 3)];
        
        const stunde = Math.floor(Math.random() * 8) + 8; // 8-16 Uhr
        const minute = [0, 15, 30, 45][Math.floor(Math.random() * 4)];
        const startZeit = `${String(stunde).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
        
        const numLeistungen = Math.floor(Math.random() * 3) + 1;
        const leistungen = [];
        let gesamtBetrag = 0;
        
        // Add Hausbesuchspauschale
        leistungen.push({
          ...LEISTUNGSKATALOG[4],
          menge: 1
        });
        gesamtBetrag += LEISTUNGSKATALOG[4].betrag;
        
        // Add random other Leistungen
        for (let j = 0; j < numLeistungen; j++) {
          const leistung = LEISTUNGSKATALOG[Math.floor(Math.random() * (LEISTUNGSKATALOG.length - 2))];
          leistungen.push({
            ...leistung,
            menge: 1
          });
          gesamtBetrag += leistung.betrag;
        }
        
        besuche.push({
          id: besuche.length + 1,
          patientId: patient.id,
          patient: patient,
          pflegerId: pfleger.id,
          pfleger: pfleger,
          datum: datum.toISOString().split('T')[0],
          startZeit: startZeit,
          endZeit: `${String(stunde + 1).padStart(2, '0')}:${String(minute).padStart(2, '0')}`,
          status: datum <= heute ? 'abgeschlossen' : 'geplant',
          leistungen: leistungen,
          gesamtBetrag: gesamtBetrag.toFixed(2),
          unterschrift: datum <= heute ? 'vorhanden' : null
        });
      }
      
      return besuche.sort((a, b) => new Date(b.datum) - new Date(a.datum));
    }
    
    // Initialize
    besuchsData = generateDemoBesuche();
    
    // ==================== AUTH ====================
    
    document.getElementById('login-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      
      const user = DEMO_USERS.find(u => u.email === email && u.password === password);
      
      if (user) {
        currentUser = user;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        initApp();
      } else {
        alert('Login fehlgeschlagen!');
      }
    });
    
    function logout() {
      currentUser = null;
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('main-app').classList.add('hidden');
      document.getElementById('login-email').value = '';
      document.getElementById('login-password').value = '';
    }
    
    // ==================== NAVIGATION ====================
    
    function initApp() {
      renderNavigation();
      navigate('home');
    }
    
    function renderNavigation() {
      const navItems = {
        pfleger: [
          { id: 'home', icon: 'üè†', label: 'Start' },
          { id: 'besuche', icon: 'üìã', label: 'Besuche' },
          { id: 'neu', icon: '‚ûï', label: 'Neu' },
          { id: 'patienten', icon: 'üë•', label: 'Patienten' },
          { id: 'profil', icon: 'üë§', label: 'Profil' }
        ],
        admin: [
          { id: 'home', icon: 'üè†', label: 'Dashboard' },
          { id: 'besuche', icon: 'üìã', label: 'Besuche' },
          { id: 'patienten', icon: 'üë•', label: 'Patienten' },
          { id: 'pfleger', icon: 'üë®‚Äç‚öïÔ∏è', label: 'Pfleger' },
          { id: 'abrechnung', icon: 'üí∞', label: 'Abrechnung' },
          { id: 'statistiken', icon: 'üìä', label: 'Statistiken' }
        ]
      };
      
      const items = navItems[currentUser.role] || navItems.pfleger;
      
      // Bottom Nav
      const bottomNav = document.getElementById('bottom-nav');
      bottomNav.innerHTML = items.slice(0, 5).map(item => `
        <a href="#" class="nav-item ${currentRoute === item.id ? 'active' : ''}" onclick="navigate('${item.id}'); return false;">
          <div class="icon">${item.icon}</div>
          <div class="label">${item.label}</div>
        </a>
      `).join('');
      
      // Desktop Sidebar
      const desktopNav = document.getElementById('desktop-nav');
      desktopNav.innerHTML = items.map(item => `
        <a href="#" class="sidebar-item ${currentRoute === item.id ? 'active' : ''}" onclick="navigate('${item.id}'); return false;">
          <span class="icon">${item.icon}</span>
          <span>${item.label}</span>
        </a>
      `).join('');
    }
    
    function navigate(route) {
      currentRoute = route;
      renderNavigation();
      
      const routes = {
        home: currentUser.role === 'admin' ? renderAdminDashboard : renderPflegerHome,
        besuche: renderBesuche,
        neu: renderNeuBesuch,
        patienten: renderPatienten,
        pfleger: renderPflegerVerwaltung,
        abrechnung: renderAbrechnung,
        statistiken: renderStatistiken,
        profil: renderProfil
      };
      
      const renderFn = routes[route] || renderPflegerHome;
      renderFn();
      
      window.scrollTo(0, 0);
    }
    
    // ==================== VIEWS ====================
    
    function renderPflegerHome() {
      const heute = new Date().toISOString().split('T')[0];
      const meineBesucheHeute = besuchsData.filter(b => 
        b.pflegerId === currentUser.id && b.datum === heute
      );
      
      const aktiverBesuch = meineBesucheHeute.find(b => b.status === 'aktiv');
      const naechsteBesuche = meineBesucheHeute.filter(b => b.status === 'geplant').slice(0, 3);
      
      document.getElementById('content-area').innerHTML = `
        <div class="greeting">Hallo, ${currentUser.name.split(' ')[0]}! üëã</div>
        <div class="date-display">${formatDate(new Date())}</div>
        
        ${aktiverBesuch ? `
          <div class="card active-visit-card">
            <div class="card-header">
              <div>
                <div class="card-title">üü¢ Aktiver Besuch</div>
                <div class="card-subtitle">${aktiverBesuch.patient.vorname} ${aktiverBesuch.patient.nachname}</div>
              </div>
            </div>
            <div style="margin-top: 1rem;">
              <div style="margin-bottom: 0.5rem;">Start: ${aktiverBesuch.startZeit}</div>
              <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary btn-sm" onclick="showBesuchDetails(${aktiverBesuch.id})">Details</button>
                <button class="btn btn-success btn-sm" onclick="abschliessenBesuch(${aktiverBesuch.id})">‚úì Abschlie√üen</button>
              </div>
            </div>
          </div>
        ` : ''}
        
        <div class="section-title">N√ÑCHSTE BESUCHE</div>
        
        ${naechsteBesuche.length > 0 ? naechsteBesuche.map(besuch => `
          <div class="list-item" onclick="showBesuchDetails(${besuch.id})">
            <div class="list-item-icon">üë§</div>
            <div class="list-item-content">
              <div class="list-item-title">${besuch.startZeit} ‚Ä¢ ${besuch.patient.vorname} ${besuch.patient.nachname}</div>
              <div class="list-item-subtitle">${besuch.patient.strasse}, ${besuch.patient.stadt}</div>
            </div>
            <div class="list-item-action">‚Ä∫</div>
          </div>
        `).join('') : '<p class="text-muted text-center">Keine weiteren Besuche heute</p>'}
        
        <button class="btn btn-primary btn-block mt-1" onclick="navigate('besuche')">Alle Besuche anzeigen</button>
      `;
    }
    
    function renderAdminDashboard() {
      const thisMonth = new Date().getMonth();
      const besucheThisMonth = besuchsData.filter(b => new Date(b.datum).getMonth() === thisMonth);
      const umsatz = besucheThisMonth.reduce((sum, b) => sum + parseFloat(b.gesamtBetrag), 0);
      const anzahlBesuche = besucheThisMonth.length;
      const durchschnitt = umsatz / DEMO_PATIENTEN.length;
      const offeneUnterschriften = besucheThisMonth.filter(b => !b.unterschrift).length;
      
      document.getElementById('content-area').innerHTML = `
        <div class="greeting">Dashboard</div>
        <div class="date-display">${formatDate(new Date(), true)}</div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value">${umsatz.toFixed(0)}‚Ç¨</div>
            <div class="stat-label">Umsatz</div>
            <div class="stat-change up">‚Üó +12%</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${anzahlBesuche}</div>
            <div class="stat-label">Besuche</div>
            <div class="stat-change up">‚Üó +5%</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${durchschnitt.toFixed(0)}‚Ç¨</div>
            <div class="stat-label">√ò pro Patient</div>
            <div class="stat-change up">‚Üó +3%</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${DEMO_PATIENTEN.length}</div>
            <div class="stat-label">Patienten</div>
            <div class="stat-change">‚Üí ¬±0%</div>
          </div>
        </div>
        
        ${offeneUnterschriften > 0 ? `
          <div class="card" style="border-left: 4px solid var(--warning);">
            <div class="card-header">
              <div class="card-title">‚ö†Ô∏è Abrechnung ${formatDate(new Date(), true, true)}</div>
            </div>
            <div>
              <p>${offeneUnterschriften} fehlende Unterschriften</p>
              <button class="btn btn-primary btn-sm mt-1" onclick="navigate('abrechnung')">Zur Abrechnung ‚Üí</button>
            </div>
          </div>
        ` : ''}
        
        <div class="section-title">SCHNELLZUGRIFF</div>
        
        <div class="list-item" onclick="navigate('besuche')">
          <div class="list-item-icon">üìã</div>
          <div class="list-item-content">
            <div class="list-item-title">Alle Besuche</div>
            <div class="list-item-subtitle">${besucheThisMonth.length} diesen Monat</div>
          </div>
          <div class="list-item-action">‚Ä∫</div>
        </div>
        
        <div class="list-item" onclick="navigate('patienten')">
          <div class="list-item-icon">üë•</div>
          <div class="list-item-content">
            <div class="list-item-title">Patienten</div>
            <div class="list-item-subtitle">${DEMO_PATIENTEN.length} aktive Patienten</div>
          </div>
          <div class="list-item-action">‚Ä∫</div>
        </div>
        
        <div class="list-item" onclick="navigate('pfleger')">
          <div class="list-item-icon">üë®‚Äç‚öïÔ∏è</div>
          <div class="list-item-content">
            <div class="list-item-title">Pflegekr√§fte</div>
            <div class="list-item-subtitle">${DEMO_USERS.filter(u => u.role === 'pfleger').length} Mitarbeiter</div>
          </div>
          <div class="list-item-action">‚Ä∫</div>
        </div>
        
        <div class="list-item" onclick="navigate('abrechnung')">
          <div class="list-item-icon">üí∞</div>
          <div class="list-item-content">
            <div class="list-item-title">Abrechnung</div>
            <div class="list-item-subtitle">AS Bremen Export</div>
          </div>
          <div class="list-item-action">‚Ä∫</div>
        </div>
      `;
    }
    
    function renderBesuche() {
      const meineBesuche = currentUser.role === 'admin' 
        ? besuchsData 
        : besuchsData.filter(b => b.pflegerId === currentUser.id);
      
      const heute = new Date().toISOString().split('T')[0];
      const besucheHeute = meineBesuche.filter(b => b.datum === heute);
      const besucheVergangene = meineBesuche.filter(b => b.datum < heute).slice(0, 10);
      
      document.getElementById('content-area').innerHTML = `
        <div class="greeting">Besuche</div>
        
        ${besucheHeute.length > 0 ? `
          <div class="section-title">HEUTE</div>
          ${besucheHeute.map(besuch => renderBesuchItem(besuch)).join('')}
        ` : ''}
        
        <div class="section-title">VERGANGENE BESUCHE</div>
        ${besucheVergangene.map(besuch => renderBesuchItem(besuch)).join('')}
      `;
    }
    
    function renderBesuchItem(besuch) {
      return `
        <div class="list-item" onclick="showBesuchDetails(${besuch.id})">
          <div class="list-item-icon">${besuch.unterschrift ? '‚úÖ' : '‚è≥'}</div>
          <div class="list-item-content">
            <div class="list-item-title">${formatDate(new Date(besuch.datum), false)} ${besuch.startZeit} ‚Ä¢ ${besuch.patient.vorname} ${besuch.patient.nachname}</div>
            <div class="list-item-subtitle">${besuch.leistungen.length} Leistungen ‚Ä¢ ${besuch.gesamtBetrag}‚Ç¨</div>
          </div>
          <div class="list-item-action">‚Ä∫</div>
        </div>
      `;
    }
    
    function showBesuchDetails(besuchId) {
      const besuch = besuchsData.find(b => b.id === besuchId);
      if (!besuch) return;
      
      currentBesuch = besuch;
      
      document.getElementById('content-area').innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
          <button class="btn btn-secondary btn-sm" onclick="navigate('besuche')">‚Üê Zur√ºck</button>
          <h2 style="flex: 1; margin: 0;">Besuchsdetails</h2>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">${besuch.patient.vorname} ${besuch.patient.nachname}</div>
              <div class="card-subtitle">${besuch.patient.strasse}, ${besuch.patient.stadt}</div>
            </div>
            <span class="badge badge-${besuch.unterschrift ? 'success' : 'warning'}">
              ${besuch.unterschrift ? '‚úì Abgeschlossen' : '‚è≥ Offen'}
            </span>
          </div>
          <div>
            <div style="margin-bottom: 0.5rem;"><strong>Datum:</strong> ${formatDate(new Date(besuch.datum))}</div>
            <div style="margin-bottom: 0.5rem;"><strong>Zeit:</strong> ${besuch.startZeit} - ${besuch.endZeit}</div>
            <div style="margin-bottom: 0.5rem;"><strong>Pfleger:</strong> ${besuch.pfleger.name}</div>
            <div><strong>Pflegegrad:</strong> ${besuch.patient.pflegegrad}</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">Leistungen</div>
            ${!besuch.unterschrift ? `
              <button class="btn btn-primary btn-sm" onclick="openLeistungModal()">+ Hinzuf√ºgen</button>
            ` : ''}
          </div>
          <div>
            ${besuch.leistungen.map((leistung, idx) => `
              <div class="leistung-item">
                <div class="leistung-info">
                  <div class="leistung-title">${leistung.bezeichnung}</div>
                  <div class="leistung-details">${leistung.id} ‚Ä¢ ${leistung.menge}x</div>
                </div>
                <div class="leistung-price">${leistung.betrag.toFixed(2)}‚Ç¨</div>
              </div>
            `).join('')}
            
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid var(--border); font-weight: 600; display: flex; justify-content: space-between;">
              <span>Gesamt:</span>
              <span style="color: var(--primary);">${besuch.gesamtBetrag}‚Ç¨</span>
            </div>
          </div>
        </div>
        
        ${!besuch.unterschrift ? `
          <button class="btn btn-success btn-block" onclick="openSignatureModal()">
            üìù Unterschrift erfassen
          </button>
        ` : `
          <div class="card">
            <div class="card-title">‚úì Unterschrift vorhanden</div>
            <p class="text-muted" style="margin-top: 0.5rem;">Dieser Besuch wurde abgeschlossen und unterschrieben.</p>
          </div>
        `}
      `;
    }
    
    function renderNeuBesuch() {
      document.getElementById('content-area').innerHTML = `
        <div class="greeting">Neuer Besuch</div>
        
        <div class="card">
          <div class="card-title">Patient ausw√§hlen</div>
          <div style="margin-top: 1rem;">
            ${DEMO_PATIENTEN.map(patient => `
              <div class="list-item" onclick="createNeuBesuch(${patient.id})">
                <div class="list-item-icon">üë§</div>
                <div class="list-item-content">
                  <div class="list-item-title">${patient.vorname} ${patient.nachname}</div>
                  <div class="list-item-subtitle">${patient.pflegegrad} ‚Ä¢ ${patient.kassenname}</div>
                </div>
                <div class="list-item-action">‚Ä∫</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }
    
    function createNeuBesuch(patientId) {
      const patient = DEMO_PATIENTEN.find(p => p.id === patientId);
      const jetzt = new Date();
      const datum = jetzt.toISOString().split('T')[0];
      const stunde = jetzt.getHours();
      const minute = jetzt.getMinutes();
      const startZeit = `${String(stunde).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
      
      const neuerBesuch = {
        id: besuchsData.length + 1,
        patientId: patient.id,
        patient: patient,
        pflegerId: currentUser.id,
        pfleger: currentUser,
        datum: datum,
        startZeit: startZeit,
        endZeit: null,
        status: 'aktiv',
        leistungen: [
          { ...LEISTUNGSKATALOG[4], menge: 1 } // Hausbesuchspauschale
        ],
        gesamtBetrag: LEISTUNGSKATALOG[4].betrag.toFixed(2),
        unterschrift: null
      };
      
      besuchsData.unshift(neuerBesuch);
      showBesuchDetails(neuerBesuch.id);
    }
    
    function renderPatienten() {
      document.getElementById('content-area').innerHTML = `
        <div class="greeting">Patienten</div>
        
        <div class="form-group">
          <input type="text" class="form-input" placeholder="üîç Patienten suchen..." oninput="filterPatienten(this.value)">
        </div>
        
        <div id="patienten-list">
          ${DEMO_PATIENTEN.map(patient => `
            <div class="list-item patient-item">
              <div class="list-item-icon">üë§</div>
              <div class="list-item-content">
                <div class="list-item-title">${patient.vorname} ${patient.nachname}</div>
                <div class="list-item-subtitle">${patient.pflegegrad} ‚Ä¢ ${patient.kassenname}</div>
                <div class="list-item-subtitle">${patient.strasse}, ${patient.plz} ${patient.stadt}</div>
              </div>
              <div class="list-item-action">‚Ä∫</div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    function filterPatienten(search) {
      const filtered = DEMO_PATIENTEN.filter(p => 
        `${p.vorname} ${p.nachname}`.toLowerCase().includes(search.toLowerCase())
      );
      
      document.getElementById('patienten-list').innerHTML = filtered.map(patient => `
        <div class="list-item">
          <div class="list-item-icon">üë§</div>
          <div class="list-item-content">
            <div class="list-item-title">${patient.vorname} ${patient.nachname}</div>
            <div class="list-item-subtitle">${patient.pflegegrad} ‚Ä¢ ${patient.kassenname}</div>
          </div>
          <div class="list-item-action">‚Ä∫</div>
        </div>
      `).join('');
    }
    
    function renderPflegerVerwaltung() {
      const pfleger = DEMO_USERS.filter(u => u.role === 'pfleger');
      
      document.getElementById('content-area').innerHTML = `
        <div class="greeting">Pflegekr√§fte</div>
        
        ${pfleger.map(p => {
          const besucheCount = besuchsData.filter(b => b.pflegerId === p.id).length;
          return `
            <div class="list-item">
              <div class="list-item-icon">üë®‚Äç‚öïÔ∏è</div>
              <div class="list-item-content">
                <div class="list-item-title">${p.name}</div>
                <div class="list-item-subtitle">${besucheCount} Besuche ‚Ä¢ ${p.beschaeftigungsnummer}</div>
              </div>
              <span class="badge badge-success">Aktiv</span>
            </div>
          `;
        }).join('')}
      `;
    }
    
    function renderAbrechnung() {
      const heute = new Date();
      const thisMonth = heute.getMonth();
      const thisYear = heute.getFullYear();
      const monthName = heute.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
      
      const besucheThisMonth = besuchsData.filter(b => {
        const d = new Date(b.datum);
        return d.getMonth() === thisMonth && d.getFullYear() === thisYear;
      });
      
      const gesamtBetrag = besucheThisMonth.reduce((sum, b) => sum + parseFloat(b.gesamtBetrag), 0);
      const offeneUnterschriften = besucheThisMonth.filter(b => !b.unterschrift);
      
      document.getElementById('content-area').innerHTML = `
        <div class="greeting">Abrechnung</div>
        <div class="date-display">${monthName}</div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">Status</div>
            <span class="badge ${offeneUnterschriften.length === 0 ? 'badge-success' : 'badge-warning'}">
              ${offeneUnterschriften.length === 0 ? '‚úì Bereit' : '‚è≥ In Vorbereitung'}
            </span>
          </div>
          <div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
              <div>
                <div class="text-muted" style="font-size: 0.875rem;">Leistungen</div>
                <div style="font-size: 1.5rem; font-weight: 600;">${besucheThisMonth.reduce((sum, b) => sum + b.leistungen.length, 0)}</div>
              </div>
              <div>
                <div class="text-muted" style="font-size: 0.875rem;">Gesamt-Betrag</div>
                <div style="font-size: 1.5rem; font-weight: 600; color: var(--primary);">${gesamtBetrag.toFixed(2)}‚Ç¨</div>
              </div>
            </div>
            
            ${offeneUnterschriften.length > 0 ? `
              <div style="margin-top: 1rem; padding: 1rem; background: rgba(255, 169, 77, 0.1); border-radius: 8px;">
                <strong style="color: var(--warning);">‚ö†Ô∏è ${offeneUnterschriften.length} fehlende Unterschriften</strong>
                <div style="margin-top: 0.5rem; font-size: 0.875rem;">
                  Bitte vervollst√§ndigen Sie alle Besuche bevor Sie die Abrechnung erstellen.
                </div>
              </div>
            ` : ''}
          </div>
        </div>
        
        <div class="card">
          <div class="card-title">Schritte zur Abrechnung</div>
          <div style="margin-top: 1rem;">
            <div style="display: flex; align-items: center; margin-bottom: 1rem;">
              <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--success); color: white; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">‚úì</div>
              <div>
                <div style="font-weight: 500;">1. Leistungen erfassen</div>
                <div style="font-size: 0.875rem; color: var(--text-muted);">Alle Besuche dokumentiert</div>
              </div>
            </div>
            
            <div style="display: flex; align-items: center; margin-bottom: 1rem;">
              <div style="width: 32px; height: 32px; border-radius: 50%; background: ${offeneUnterschriften.length === 0 ? 'var(--success)' : 'var(--warning)'}; color: white; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">${offeneUnterschriften.length === 0 ? '‚úì' : '‚è≥'}</div>
              <div>
                <div style="font-weight: 500;">2. Pr√ºfung & Unterschriften</div>
                <div style="font-size: 0.875rem; color: var(--text-muted);">${offeneUnterschriften.length === 0 ? 'Vollst√§ndig' : offeneUnterschriften.length + ' fehlen'}</div>
              </div>
            </div>
            
            <div style="display: flex; align-items: center; margin-bottom: 1rem;">
              <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--border); color: var(--text-muted); display: flex; align-items: center; justify-content: center; margin-right: 1rem;">3</div>
              <div>
                <div style="font-weight: 500;">3. XML erstellen</div>
                <div style="font-size: 0.875rem; color: var(--text-muted);">F√ºr AS Bremen</div>
              </div>
            </div>
            
            <div style="display: flex; align-items: center;">
              <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--border); color: var(--text-muted); display: flex; align-items: center; justify-content: center; margin-right: 1rem;">4</div>
              <div>
                <div style="font-weight: 500;">4. An AS Bremen senden</div>
                <div style="font-size: 0.875rem; color: var(--text-muted);">Via API</div>
              </div>
            </div>
          </div>
        </div>
        
        ${offeneUnterschriften.length > 0 ? `
          <div class="card">
            <div class="card-title">Fehlende Unterschriften (${offeneUnterschriften.length})</div>
            <div style="margin-top: 1rem;">
              ${offeneUnterschriften.slice(0, 5).map(besuch => `
                <div class="list-item" onclick="showBesuchDetails(${besuch.id})">
                  <div class="list-item-icon">‚ö†Ô∏è</div>
                  <div class="list-item-content">
                    <div class="list-item-title">${besuch.patient.vorname} ${besuch.patient.nachname}</div>
                    <div class="list-item-subtitle">${formatDate(new Date(besuch.datum))} ‚Ä¢ ${besuch.startZeit}</div>
                  </div>
                  <div class="list-item-action">‚Ä∫</div>
                </div>
              `).join('')}
            </div>
          </div>
        ` : `
          <button class="btn btn-primary btn-block" onclick="alert('üéâ XML-Datei w√ºrde jetzt erstellt werden!\\n\\nIn der echten App wird hier die XML-Datei gem√§√ü AS Bremen Schema generiert.')">
            üì§ XML erstellen & senden
          </button>
        `}
      `;
    }
    
    function renderStatistiken() {
      const heute = new Date();
      const thisMonth = heute.getMonth();
      const besucheThisMonth = besuchsData.filter(b => new Date(b.datum).getMonth() === thisMonth);
      
      // Stats by Patient
      const patientStats = {};
      besucheThisMonth.forEach(b => {
        if (!patientStats[b.patientId]) {
          patientStats[b.patientId] = {
            patient: b.patient,
            anzahl: 0,
            umsatz: 0
          };
        }
        patientStats[b.patientId].anzahl++;
        patientStats[b.patientId].umsatz += parseFloat(b.gesamtBetrag);
      });
      
      const topPatienten = Object.values(patientStats)
        .sort((a, b) => b.umsatz - a.umsatz)
        .slice(0, 5);
      
      document.getElementById('content-area').innerHTML = `
        <div class="greeting">Statistiken</div>
        <div class="date-display">${formatDate(heute, true, true)}</div>
        
        <div class="card">
          <div class="card-title">Top 5 Patienten nach Umsatz</div>
          <div style="margin-top: 1rem;">
            ${topPatienten.map((stat, idx) => `
              <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                <div>
                  <div style="font-weight: 500;">${idx + 1}. ${stat.patient.vorname} ${stat.patient.nachname}</div>
                  <div style="font-size: 0.875rem; color: var(--text-muted);">${stat.anzahl} Besuche</div>
                </div>
                <div style="font-weight: 600; color: var(--primary);">${stat.umsatz.toFixed(2)}‚Ç¨</div>
              </div>
            `).join('')}
          </div>
        </div>
        
        <div class="card">
          <div class="card-title">Leistungsverteilung</div>
          <div style="margin-top: 1rem;">
            ${LEISTUNGSKATALOG.slice(0, 5).map(leistung => {
              const count = besucheThisMonth.reduce((sum, b) => {
                return sum + b.leistungen.filter(l => l.id === leistung.id).length;
              }, 0);
              return `
                <div style="margin-bottom: 1rem;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span style="font-size: 0.875rem;">${leistung.bezeichnung}</span>
                    <span style="font-weight: 600;">${count}x</span>
                  </div>
                  <div style="background: var(--bg); height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: var(--primary); height: 100%; width: ${Math.min(count * 2, 100)}%;"></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }
    
    function renderProfil() {
      const meineBesuche = besuchsData.filter(b => b.pflegerId === currentUser.id);
      const thisMonth = new Date().getMonth();
      const besucheThisMonth = meineBesuche.filter(b => new Date(b.datum).getMonth() === thisMonth);
      
      document.getElementById('content-area').innerHTML = `
        <div class="greeting">Profil</div>
        
        <div class="card">
          <div style="text-align: center;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">üë§</div>
            <h2>${currentUser.name}</h2>
            <p class="text-muted">${currentUser.role === 'admin' ? 'Administrator' : 'Pflegekraft'}</p>
            <p class="text-muted" style="font-size: 0.875rem;">Besch√§ftigungsnummer: ${currentUser.beschaeftigungsnummer}</p>
          </div>
        </div>
        
        ${currentUser.role === 'pfleger' ? `
          <div class="card">
            <div class="card-title">Meine Statistik (Diesen Monat)</div>
            <div style="margin-top: 1rem;">
              <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg); border-radius: 8px; margin-bottom: 0.5rem;">
                <span>Besuche</span>
                <strong>${besucheThisMonth.length}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg); border-radius: 8px; margin-bottom: 0.5rem;">
                <span>Leistungen</span>
                <strong>${besucheThisMonth.reduce((sum, b) => sum + b.leistungen.length, 0)}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg); border-radius: 8px;">
                <span>Umsatz</span>
                <strong style="color: var(--primary);">${besucheThisMonth.reduce((sum, b) => sum + parseFloat(b.gesamtBetrag), 0).toFixed(2)}‚Ç¨</strong>
              </div>
            </div>
          </div>
        ` : ''}
        
        <button class="btn btn-secondary btn-block" onclick="logout()">
          üö™ Abmelden
        </button>
      `;
    }
    
    // ==================== MODALS ====================
    
    function openLeistungModal() {
      document.getElementById('leistung-modal').classList.add('active');
      renderLeistungList();
    }
    
    function renderLeistungList(filter = '') {
      const filtered = LEISTUNGSKATALOG.filter(l => 
        l.bezeichnung.toLowerCase().includes(filter.toLowerCase())
      );
      
      document.getElementById('leistung-list').innerHTML = filtered.map(leistung => `
        <div class="list-item" onclick="addLeistung('${leistung.id}')">
          <div class="list-item-content">
            <div class="list-item-title">${leistung.bezeichnung}</div>
            <div class="list-item-subtitle">${leistung.id} ‚Ä¢ ${leistung.kategorie}</div>
          </div>
          <div style="font-weight: 600; color: var(--primary);">${leistung.betrag.toFixed(2)}‚Ç¨</div>
        </div>
      `).join('');
    }
    
    function addLeistung(leistungId) {
      const leistung = LEISTUNGSKATALOG.find(l => l.id === leistungId);
      if (!leistung || !currentBesuch) return;
      
      currentBesuch.leistungen.push({ ...leistung, menge: 1 });
      currentBesuch.gesamtBetrag = currentBesuch.leistungen.reduce((sum, l) => sum + l.betrag, 0).toFixed(2);
      
      closeModal('leistung-modal');
      showBesuchDetails(currentBesuch.id);
    }
    
    function openSignatureModal() {
      document.getElementById('signature-modal').classList.add('active');
      initSignaturePad();
    }
    
    function initSignaturePad() {
      const canvas = document.getElementById('signature-canvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = canvas.offsetWidth;
      canvas.height = 200;
      
      let drawing = false;
      let lastX = 0;
      let lastY = 0;
      
      function draw(e) {
        if (!drawing) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.stroke();
        
        lastX = x;
        lastY = y;
      }
      
      function startDrawing(e) {
        drawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        lastY = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
      }
      
      function stopDrawing() {
        drawing = false;
      }
      
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('touchstart', startDrawing);
      canvas.addEventListener('touchmove', draw);
      canvas.addEventListener('touchend', stopDrawing);
    }
    
    function clearSignature() {
      const canvas = document.getElementById('signature-canvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    
    function saveSignature() {
      if (!currentBesuch) return;
      
      currentBesuch.unterschrift = 'vorhanden';
      currentBesuch.status = 'abgeschlossen';
      
      if (!currentBesuch.endZeit) {
        const jetzt = new Date();
        currentBesuch.endZeit = `${String(jetzt.getHours()).padStart(2, '0')}:${String(jetzt.getMinutes()).padStart(2, '0')}`;
      }
      
      closeModal('signature-modal');
      showBesuchDetails(currentBesuch.id);
      
      alert('‚úì Unterschrift gespeichert!\n\nBesuch wurde erfolgreich abgeschlossen.');
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }
    
    // ==================== UTILS ====================
    
    function formatDate(date, withMonth = false, onlyMonth = false) {
      if (onlyMonth) {
        return date.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
      }
      
      const options = withMonth 
        ? { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }
        : { weekday: 'short', day: 'numeric', month: 'short' };
      
      return date.toLocaleDateString('de-DE', options);
    }
    
    function showNotifications() {
      alert('üîî Benachrichtigungen\n\nKeine neuen Benachrichtigungen.');
    }
    
    function abschliessenBesuch(besuchId) {
      const besuch = besuchsData.find(b => b.id === besuchId);
      if (!besuch) return;
      
      openSignatureModal();
    }
    
    // Search input for Leistung modal
    document.getElementById('leistung-search')?.addEventListener('input', (e) => {
      renderLeistungList(e.target.value);
    });
    
    // Close modals on background click
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
    });
  </script>
</body>
</html>
