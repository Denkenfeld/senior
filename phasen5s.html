<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vitakreis Onboarding Planer V3.7</title>
    <style>
        :root {
            --primary: #2c7a7b; 
            --primary-light: #e6fffa; 
            --primary-dark: #234e52; 
            --accent: #ed8936;
            --bg: #f7fafc; 
            --surface: #ffffff; 
            --text: #2d3748; 
            --text-light: #718096; 
            --border: #e2e8f0;
            --success: #48bb78; 
            --running: #4299e1; 
            --gray: #a0aec0; 
            --radius: 8px; 
            --shadow: 0 4px 6px -1px rgba(44, 122, 123, 0.1);
        }

        body { font-family: 'Inter', system-ui, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; display: flex; height: 100vh; overflow: hidden; transition: background-color 0.3s, color 0.3s; }

        /* --- SIDEBAR --- */
        aside { width: 320px; min-width: 320px; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; overflow-y: auto; z-index: 10; box-shadow: 2px 0 5px rgba(44, 122, 123, 0.05); transition: background-color 0.3s, border-color 0.3s; }
        aside h2 { font-size: 1.3rem; color: var(--primary); margin-top: 0; margin-bottom: 15px; font-weight: 600; font-family: "Segoe UI", "Inter", system-ui, sans-serif; text-align: left;}
        aside h3 { font-size: 0.8rem; text-transform: uppercase; color: var(--text-light); margin-top: 25px; margin-bottom: 10px; letter-spacing: 1px; font-weight: 700; border-bottom: 1px solid var(--border); padding-bottom: 5px;}

        .draggable-item { background: var(--surface); border: 1px solid var(--border); padding: 10px; margin-bottom: 8px; border-radius: var(--radius); cursor: grab; font-size: 0.9rem; display: flex; align-items: center; transition: all 0.2s; }

        .status-box { 
            display: inline-block; 
            width: 22px; 
            height: 22px; 
            border: 1px solid var(--border); 
            border-radius: 3px; 
            text-align: center; 
            line-height: 22px; 
            font-size: 0.7rem; 
            font-weight: 700; 
            margin-right: 8px; 
            background: var(--bg);
            color: var(--text-light);
            flex-shrink: 0;
        }
        .status-box.status-running { color: var(--running); background: #ebf8ff; }
        .status-box.status-done { color: var(--success); background: #f0fff4; }

        .draggable-item:hover { border-color: var(--accent); transform: translateX(3px); box-shadow: var(--shadow); }


        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .panel-toggle-btn { background: none; border: none; cursor: pointer; font-size: 1rem; padding: 5px 8px; color: var(--primary); transition: transform 0.2s; border-radius: 4px; }
        .panel-toggle-btn:hover { background: var(--bg); transform: rotate(180deg); }

        .sidebar-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border); font-size: 0.8rem; color: var(--text-light); text-align: center; }

        /* --- MAIN CONTENT --- */
        main { flex-grow: 1; padding: 0; overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column; background-image: radial-gradient(var(--border) 1px, transparent 1px); background-size: 20px 20px; }

        header { display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; background: var(--surface); border-bottom: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.03); position: sticky; top: 0; z-index: 100; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-left img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--primary); }

        .candidate-name { font-size: 1.8rem; font-weight: 800; color: var(--text); cursor: text; padding: 3px 8px; border-radius: 4px; transition: background 0.2s; }
        .candidate-name:hover { background: var(--primary-light); }
        .candidate-name:focus { outline: none; background: var(--primary-light); }

        .toolbar-actions { display: flex; gap: 10px; align-items: center; }
        .toolbar-btn { background: var(--primary); color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .toolbar-btn:hover { background: var(--primary-dark); transform: translateY(-1px); box-shadow: 0 4px 8px rgba(44,122,123,0.2); }

        /* --- CONTENT AREA --- */
        .content { padding: 30px; flex-grow: 1; }

        /* --- PHASES (TIMELINE CARDS) --- */
        .phases-container { display: flex; flex-direction: column; gap: 20px; }

        .phase { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; transition: all 0.3s; position: relative; }
        .phase:hover { box-shadow: 0 6px 15px rgba(44,122,123,0.15); }

        .phase-header { padding: 15px 20px; background: linear-gradient(135deg, var(--primary-light), var(--surface)); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; }
        .phase-header:hover { background: var(--primary-light); }

        .phase-title { font-size: 1.2rem; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 8px; }
        .phase-duration { font-size: 0.85rem; color: var(--text-light); background: var(--bg); padding: 4px 10px; border-radius: 12px; }

        .phase-content { padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .phase.minimized .phase-content { display: none; }

        /* --- TIMELINE ITEMS (TASKS) --- */
        .timeline-item { background: var(--bg); border-left: 3px solid var(--border); padding: 12px 15px; border-radius: 4px; transition: all 0.2s; cursor: move; position: relative; }
        .timeline-item:hover { border-left-color: var(--accent); background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }

        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .item-title { font-weight: 600; font-size: 0.95rem; color: var(--text); flex-grow: 1; }
        .item-description { font-size: 0.85rem; color: var(--text-light); margin-bottom: 10px; line-height: 1.4; }

        .item-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; }
        .item-status select { padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border); background: white; cursor: pointer; font-size: 0.8rem; }

        .module-assignees { display: flex; gap: 5px; }
        .module-avatar { width: 24px; height: 24px; border-radius: 50%; background: var(--gray); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .module-avatar:hover { transform: scale(1.15); }

        /* --- PERSON CHIPS (DRAGGABLE TEAM) --- */
        .person-chip { display: flex; align-items: center; background: var(--bg); padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 8px; cursor: grab; transition: all 0.2s; font-size: 0.9rem; position: relative; }
        .person-chip:hover { border-color: var(--primary); background: white; transform: translateX(3px); }
        .person-chip.dragging { opacity: 0.5; }

        .person-chip-avatar { width: 24px; height: 24px; border-radius: 50%; background: var(--gray); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; margin-right: 8px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .person-chip-avatar:hover { transform: scale(1.2); }

        .person-name-input { border: none; background: transparent; font-size: 0.9rem; color: var(--text); outline: none; flex-grow: 1; cursor: text; }
        .person-name-input:focus { color: var(--primary); font-weight: 600; }

        .person-delete { margin-left: auto; cursor: pointer; color: var(--text-light); font-size: 1.2rem; padding: 0 5px; transition: color 0.2s; }
        .person-delete:hover { color: #e53e3e; }

        /* --- COLOR PICKER MODAL --- */
        .color-picker-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 1000; display: none; }
        .color-picker-modal.active { display: block; }
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 10px; }
        .color-option { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
        .color-option:hover { transform: scale(1.1); border-color: var(--text); }

        /* --- THEME STYLES --- */
        body.dark-theme { --bg: #1a202c; --surface: #2d3748; --text: #e2e8f0; --text-light: #a0aec0; --border: #4a5568; }
        body.nature-theme { --primary: #38a169; --accent: #f6ad55; --bg: #f0fff4; }

        /* --- DROP ZONES --- */
        .drop-zone { min-height: 50px; border: 2px dashed transparent; border-radius: 4px; transition: all 0.2s; padding: 5px; }
        .drop-zone.drag-over { border-color: var(--accent); background: var(--primary-light); }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            aside { width: 100%; min-width: 100%; border-right: none; border-bottom: 1px solid var(--border); max-height: 40vh; }
            main { padding: 15px; }
            header { flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>

<!-- ===================== SUPABASE LOGIN OVERLAY ===================== -->
<div id="login-overlay" style="
  position: fixed !important; inset: 0 !important;
  width: 100vw !important; height: 100vh !important;
  background: #f7fafc !important;
  z-index: 2147483647 !important;
  display: flex !important; align-items: center !important; justify-content: center !important;
">
  <div style="
    width: min(420px, 92vw); background: #fff; border: 1px solid #e2e8f0; border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    padding: 28px;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
  ">
    <div style="font-size: 22px; font-weight: 800; color: #234e52; margin-bottom: 6px;">Vitakreis Login</div>
    <div style="font-size: 13px; color: #718096; margin-bottom: 18px;">Bitte anmelden (E-Mail-Best√§tigung bleibt aktiv).</div>

    <label style="display:block; font-size:12px; color:#4a5568; font-weight:700; margin: 10px 0 6px;">E-Mail</label>
    <input id="sb-email" type="email" autocomplete="email" style="width:100%; padding:12px; border:1px solid #cbd5e0; border-radius:8px; box-sizing:border-box; font-size:16px;">

    <label style="display:block; font-size:12px; color:#4a5568; font-weight:700; margin: 12px 0 6px;">Passwort</label>
    <input id="sb-password" type="password" autocomplete="current-password" style="width:100%; padding:12px; border:1px solid #cbd5e0; border-radius:8px; box-sizing:border-box; font-size:16px;">

    <button id="sb-btn-login" style="width:100%; margin-top:14px; padding:12px; border:0; border-radius:8px; background:#2c7a7b; color:#fff; font-weight:800; cursor:pointer; font-size:15px;">Anmelden</button>
    <button id="sb-btn-signup" style="width:100%; margin-top:10px; padding:12px; border-radius:8px; background:#fff; color:#2c7a7b; border:1px solid #2c7a7b; font-weight:800; cursor:pointer; font-size:15px;">Registrieren</button>
    <button id="sb-btn-resend" style="width:100%; margin-top:10px; padding:10px; border-radius:8px; background:#edf2f7; color:#2d3748; border:1px solid #e2e8f0; font-weight:700; cursor:pointer; font-size:14px; display:none;">Best√§tigungs-Mail erneut senden</button>

    <div id="sb-msg" style="min-height:18px; margin-top:12px; font-size:13px; color:#718096;"></div>
  </div>
</div>
<!-- ===================== /SUPABASE LOGIN OVERLAY ===================== -->

    <!-- SIDEBAR -->
    <aside>
        <div class="panel-header">
            <h2>üåø VitaKreis</h2>
        </div>

        <!-- TEAM PANEL -->
        <h3>üë• Team / Kontakt</h3>
        <div id="team-container">
            <!-- Team members draggable -->
            <div class="person-chip" draggable="true" ondragstart="dragPerson(event)" data-id="main" data-type="person">
                <div class="person-chip-avatar" style="background-color: #4299e1;" onclick="openColorPicker(event, 'main')">M</div>
                <span class="person-name-input" id="name-main-sidebar" contenteditable="true" oninput="updatePersonName(this, 'main')">Maria</span>
            </div>
        </div>
        <button class="toolbar-btn" onclick="addPerson()" style="width: 100%; margin-top: 10px; justify-content: center;">+ Person hinzuf√ºgen</button>

        <!-- MODULE LIBRARY -->
        <h3>üì¶ Module / Aufgaben</h3>
        <div id="sidebar-items">
            <div class="draggable-item" draggable="true" ondragstart="dragModule(event)" data-type="module">
                <span class="status-box">?</span> Neues ToDo
            </div>
            <div class="draggable-item" draggable="true" ondragstart="dragModule(event)" data-type="module">
                <span class="status-box">üìÖ</span> Meeting
            </div>
            <div class="draggable-item" draggable="true" ondragstart="dragModule(event)" data-type="module">
                <span class="status-box">üìù</span> Dokumentation
            </div>
        </div>

        <!-- THEME SWITCHER -->
        <h3>üé® Themes</h3>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="toolbar-btn" onclick="setTheme('default')" style="flex: 1;">Standard</button>
            <button class="toolbar-btn" onclick="setTheme('dark-theme')" style="flex: 1; background: #2d3748;">Dark</button>
            <button class="toolbar-btn" onclick="setTheme('nature-theme')" style="flex: 1; background: #38a169;">Nature</button>
        </div>

        <div class="sidebar-footer">
            Vitakreis Onboarding Planer V3.7
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main>
        <header>
            <div class="header-left"></div>
            <div class="candidate-name" contenteditable="true" id="header-name" oninput="syncCandidateName()">Maria</div>
            <div class="toolbar-actions">
                <button class="toolbar-btn" onclick="toggleAllModules()" id="toggle-btn">üìã √úbersicht</button>
                <button class="toolbar-btn" onclick="clearTimeline()">üóëÔ∏è Reset</button>
                <button class="toolbar-btn" onclick="saveTimeline()">üíæ Speichern</button>
                <button class="toolbar-btn" onclick="saveToCloud()" id="btn-cloud-save">‚òÅÔ∏è Cloud</button>
                <button class="toolbar-btn" onclick="doLogout()" id="btn-logout">üö™ Logout</button>
            </div>
        </header>

        <div class="content">
            <div class="phases-container" id="phases-container">
                <!-- Phases will be rendered here -->
            </div>
        </div>
    </main>

    <!-- COLOR PICKER MODAL -->
    <div class="color-picker-modal" id="color-picker">
        <h4 style="margin-top: 0;">Farbe w√§hlen</h4>
        <div class="color-grid" id="color-grid"></div>
    </div>

    <!-- FILE INPUT (hidden) -->
    <input type="file" id="file-input" accept=".json" onchange="loadTimelineFile(this)" style="display: none;">

    <script>
        // ========== GLOBAL STATE ==========
        let draggedElement = null;
        let dragType = null;
        let currentColorTarget = null;

        const colorPalette = [
            '#4299e1', '#48bb78', '#ed8936', '#9f7aea', '#f56565',
            '#38b2ac', '#ecc94b', '#ed64a6', '#4fd1c5', '#fc8181',
            '#667eea', '#f6ad55', '#68d391', '#b794f4', '#f687b3'
        ];

        const defaultData = [
            { 
                title: "üéâ Phase 1: Willkommen im VitaKreis!", 
                duration: "Tag 1-3", 
                items: [
                    { text: "üíö Herzlich Willkommen", description: "Begr√º√üung durch die Gesch√§ftsf√ºhrung", status: "done", assignees: ["main"] },
                    { text: "üè¢ Office Tour", description: "Vorstellung der R√§umlichkeiten und Kollegen", status: "todo", assignees: [] },
                    { text: "üñ•Ô∏è IT-Setup", description: "Laptop und Zug√§nge einrichten", status: "todo", assignees: [] }
                ]
            },
            { 
                title: "üìö Phase 2: Einarbeitung", 
                duration: "Woche 1-2", 
                items: [
                    { text: "üìñ Schulungen", description: "Grundlagenschulungen zu Prozessen und Tools", status: "todo", assignees: [] },
                    { text: "ü§ù Team Meetings", description: "Teilnahme an ersten Team-Meetings", status: "todo", assignees: [] }
                ]
            },
            { 
                title: "üöÄ Phase 3: Erste Projekte", 
                duration: "Woche 3-4", 
                items: [
                    { text: "üéØ Projekt Kickoff", description: "Erstes eigenes Projekt starten", status: "todo", assignees: [] }
                ]
            }
        ];

        // ========== INITIALIZE ==========
        function render(data) {
            const container = document.getElementById('phases-container');
            container.innerHTML = '';

            data.forEach((phase, phaseIndex) => {
                const phaseDiv = document.createElement('div');
                phaseDiv.className = 'phase';
                phaseDiv.dataset.phaseIndex = phaseIndex;

                const header = document.createElement('div');
                header.className = 'phase-header';
                header.onclick = () => phaseDiv.classList.toggle('minimized');
                header.innerHTML = `
                    <div class="phase-title" contenteditable="true" oninput="updatePhaseTitle(${phaseIndex}, this)">${phase.title}</div>
                    <div class="phase-duration" contenteditable="true" oninput="updatePhaseDuration(${phaseIndex}, this)">${phase.duration}</div>
                `;

                const content = document.createElement('div');
                content.className = 'phase-content drop-zone';
                content.ondragover = allowDrop;
                content.ondrop = (e) => dropInPhase(e, phaseIndex);

                phase.items.forEach((item, itemIndex) => {
                    const itemDiv = createTimelineItem(item, phaseIndex, itemIndex);
                    content.appendChild(itemDiv);
                });

                phaseDiv.appendChild(header);
                phaseDiv.appendChild(content);
                container.appendChild(phaseDiv);
            });
        }

        function createTimelineItem(item, phaseIndex, itemIndex) {
            const div = document.createElement('div');
            div.className = 'timeline-item';
            div.draggable = true;
            div.ondragstart = (e) => dragTimelineItem(e, phaseIndex, itemIndex);

            const assigneeAvatars = item.assignees.map(id => {
                const person = findPersonById(id);
                return person ? `<div class="module-avatar" style="background-color: ${person.color}" data-id="${id}">${person.name.charAt(0).toUpperCase()}</div>` : '';
            }).join('');

            div.innerHTML = `
                <div class="item-header">
                    <div class="item-title" contenteditable="true" oninput="updateItemText(${phaseIndex}, ${itemIndex}, this)">${item.text}</div>
                </div>
                <div class="item-description" contenteditable="true" oninput="updateItemDescription(${phaseIndex}, ${itemIndex}, this)">${item.description}</div>
                <div class="item-meta">
                    <div class="item-status">
                        <select onchange="updateItemStatus(${phaseIndex}, ${itemIndex}, this.value)">
                            <option value="todo" ${item.status === 'todo' ? 'selected' : ''}>üìã To Do</option>
                            <option value="running" ${item.status === 'running' ? 'selected' : ''}>‚è≥ In Arbeit</option>
                            <option value="done" ${item.status === 'done' ? 'selected' : ''}>‚úÖ Erledigt</option>
                        </select>
                    </div>
                    <div class="module-assignees drop-zone" ondragover="allowDrop" ondrop="(e) => dropPersonOnItem(e, ${phaseIndex}, ${itemIndex})">
                        ${assigneeAvatars}
                    </div>
                </div>
            `;

            return div;
        }

        // ========== DRAG & DROP ==========
        function dragModule(e) {
            dragType = 'module';
            draggedElement = e.target;
            e.dataTransfer.effectAllowed = 'copy';
        }

        function dragPerson(e) {
            dragType = 'person';
            draggedElement = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'copy';
        }

        function dragTimelineItem(e, phaseIndex, itemIndex) {
            dragType = 'item';
            draggedElement = { phaseIndex, itemIndex };
            e.target.style.opacity = '0.4';
        }

        function allowDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function dropInPhase(e, phaseIndex) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            if (dragType === 'module') {
                const newItem = {
                    text: draggedElement.innerText.trim(),
                    description: "Neue Aufgabe",
                    status: "todo",
                    assignees: []
                };
                defaultData[phaseIndex].items.push(newItem);
                render(defaultData);
            }
        }

        function dropPersonOnItem(e, phaseIndex, itemIndex) {
            e.preventDefault();
            e.stopPropagation();

            if (dragType === 'person') {
                const personId = draggedElement.dataset.id;
                const item = defaultData[phaseIndex].items[itemIndex];
                
                if (!item.assignees.includes(personId)) {
                    item.assignees.push(personId);
                    render(defaultData);
                }
            }

            draggedElement?.classList?.remove('dragging');
        }

        document.addEventListener('dragend', (e) => {
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            if (e.target.classList.contains('timeline-item')) e.target.style.opacity = '1';
            draggedElement?.classList?.remove('dragging');
        });

        // ========== UPDATE FUNCTIONS ==========
        function updatePhaseTitle(index, el) {
            defaultData[index].title = el.innerText;
        }

        function updatePhaseDuration(index, el) {
            defaultData[index].duration = el.innerText;
        }

        function updateItemText(phaseIndex, itemIndex, el) {
            defaultData[phaseIndex].items[itemIndex].text = el.innerText;
        }

        function updateItemDescription(phaseIndex, itemIndex, el) {
            defaultData[phaseIndex].items[itemIndex].description = el.innerText;
        }

        function updateItemStatus(phaseIndex, itemIndex, newStatus) {
            defaultData[phaseIndex].items[itemIndex].status = newStatus;
        }

        // ========== TEAM MANAGEMENT ==========
        function addPerson() {
            const name = prompt("Name der Person:");
            if (!name) return;

            const id = 'person-' + Date.now();
            const color = colorPalette[Math.floor(Math.random() * colorPalette.length)];

            const container = document.getElementById('team-container');
            const div = document.createElement('div');
            div.className = 'person-chip';
            div.draggable = true;
            div.ondragstart = dragPerson;
            div.dataset.id = id;
            div.dataset.type = 'person';

            div.innerHTML = `
                <div class="person-chip-avatar" style="background-color: ${color}" onclick="openColorPicker(event, '${id}')">${name.charAt(0).toUpperCase()}</div>
                <span class="person-name-input" contenteditable="true" oninput="updatePersonName(this, '${id}')">${name}</span>
                <span class="person-delete" onclick="deletePerson(this)">√ó</span>
            `;

            container.appendChild(div);
        }

        function deletePerson(el) {
            el.closest('.person-chip').remove();
        }

        function updatePersonName(el, personId) {
            const newName = el.innerText.trim();
            const chip = el.closest('.person-chip');
            const avatar = chip.querySelector('.person-chip-avatar');
            avatar.textContent = newName.charAt(0).toUpperCase();

            // Sync with header if it's main
            if (personId === 'main') {
                document.getElementById('header-name').textContent = newName;
            }
        }

        function syncCandidateName() {
            const headerName = document.getElementById('header-name').innerText;
            const mainNameEl = document.getElementById('name-main-sidebar');
            if (mainNameEl) {
                mainNameEl.textContent = headerName;
                const mainChip = mainNameEl.closest('.person-chip');
                if (mainChip) {
                    const mainAvatar = mainChip.querySelector('.person-chip-avatar');
                    mainAvatar.textContent = headerName.charAt(0).toUpperCase();
                }
            }
        }

        function findPersonById(id) {
            const chip = document.querySelector(`.person-chip[data-id="${id}"]`);
            if (!chip) return null;

            const nameInput = chip.querySelector('.person-name-input');
            const avatar = chip.querySelector('.person-chip-avatar');

            return {
                id: id,
                name: nameInput.innerText.trim(),
                color: avatar.style.backgroundColor
            };
        }

        // ========== COLOR PICKER ==========
        function openColorPicker(e, personId) {
            e.stopPropagation();
            currentColorTarget = personId;

            const modal = document.getElementById('color-picker');
            const grid = document.getElementById('color-grid');
            grid.innerHTML = '';

            colorPalette.forEach(color => {
                const div = document.createElement('div');
                div.className = 'color-option';
                div.style.backgroundColor = color;
                div.onclick = () => applyColor(color);
                grid.appendChild(div);
            });

            modal.classList.add('active');
        }

        function applyColor(color) {
            const chip = document.querySelector(`.person-chip[data-id="${currentColorTarget}"]`);
            if (chip) {
                chip.querySelector('.person-chip-avatar').style.backgroundColor = color;
            }
            document.getElementById('color-picker').classList.remove('active');
        }

        document.addEventListener('click', (e) => {
            const modal = document.getElementById('color-picker');
            if (!modal.contains(e.target) && !e.target.classList.contains('person-chip-avatar')) {
                modal.classList.remove('active');
            }
        });

        // ========== THEME ==========
        function setTheme(theme) {
            document.body.className = theme;
            localStorage.setItem('selectedTheme', theme);
        }

        // ========== SAVE / LOAD ==========
        function saveTimeline() {
            // Speichere Phasen und Module
            const phases = [...document.querySelectorAll('.phase')].map(p => ({
                title: p.querySelector('.phase-title').innerText,
                duration: p.querySelector('.phase-duration').innerText,
                items: [...p.querySelectorAll('.timeline-item')].map(i => ({
                    text: i.querySelector('.item-title').innerText,
                    description: i.querySelector('.item-description').innerText,
                    status: i.querySelector('select').value,
                    assignees: [...i.querySelectorAll('.module-avatar')].map(av => av.dataset.id)
                }))
            }));

            // Speichere Team/Mitarbeiter mit korrekten Namen
            const team = [...document.querySelectorAll('#team-container .person-chip')].map(chip => {
                const nameInput = chip.querySelector('.person-name-input');
                const name = nameInput.textContent.trim() || nameInput.innerText.trim();
                return {
                    id: chip.dataset.id,
                    name: name,
                    color: rgbToHex(chip.querySelector('.person-chip-avatar').style.backgroundColor)
                };
            });

            // Speichere Kandidatenname korrekt
            const headerNameEl = document.getElementById('header-name');
            const candidateName = (headerNameEl.textContent || headerNameEl.innerText).trim();

            // Speichere aktuelles Theme
            const currentTheme = localStorage.getItem('selectedTheme') || 'default';

            // Erstelle vollst√§ndiges Datenobjekt
            const fullData = {
                candidateName: candidateName,
                theme: currentTheme,
                team: team,
                phases: phases
            };

            console.log('üíæ Speichere:', fullData);

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(fullData, null, 2));
            const dl = document.createElement('a');
            dl.href = dataStr;
            dl.download = 'vitakreisplan.json';
            dl.click();
        }

        function loadTimelineInput() { 
            document.getElementById('file-input').click(); 
        }

        function loadTimelineFile(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = JSON.parse(e.target.result);

                console.log('üìÇ Lade Daten:', data);

                // Pr√ºfe ob es das neue oder alte Format ist
                if (Array.isArray(data)) {
                    // Altes Format - nur Phasen
                    render(data);
                } else {
                    // Neues Format - mit allen Daten

                    // Lade Theme zuerst
                    if (data.theme) {
                        setTheme(data.theme);
                    }

                    // Lade Team/Mitarbeiter VOR dem Kandidatennamen
                    if (data.team && data.team.length > 0) {
                        const teamContainer = document.getElementById('team-container');
                        // Entferne ALLE bestehenden Mitarbeiter
                        teamContainer.innerHTML = '';

                        // F√ºge alle geladenen Mitarbeiter hinzu
                        data.team.forEach(person => {
                            const div = document.createElement('div');
                            div.className = 'person-chip';
                            div.draggable = true;
                            div.dataset.id = person.id;
                            div.dataset.type = 'person';

                            const initial = person.name.charAt(0).toUpperCase();
                            const deleteBtn = person.id === 'main' ? '' : '<span class="person-delete" onclick="deletePerson(this)">√ó</span>';
                            const idAttr = person.id === 'main' ? 'id="name-main-sidebar"' : '';

                            div.innerHTML = `
                                <div class="person-chip-avatar" style="background-color: ${person.color}" onclick="openColorPicker(event, '${person.id}')">${initial}</div>
                                <span class="person-name-input" ${idAttr} contenteditable="true" oninput="updatePersonName(this, '${person.id}')">${person.name}</span>
                                ${deleteBtn}
                            `;
                            teamContainer.appendChild(div);
                        });
                    }

                    // Lade Kandidatenname und synchronisiere
                    if (data.candidateName) {
                        const headerName = document.getElementById('header-name');
                        headerName.textContent = data.candidateName;

                        // Aktualisiere auch den Hauptmitarbeiter in der Sidebar
                        const mainNameEl = document.getElementById('name-main-sidebar');
                        if (mainNameEl) {
                            mainNameEl.textContent = data.candidateName;
                            const mainChip = mainNameEl.closest('.person-chip');
                            if (mainChip) {
                                const mainAvatar = mainChip.querySelector('.person-chip-avatar');
                                mainAvatar.textContent = data.candidateName.charAt(0).toUpperCase();
                            }
                        }
                    }

                    // Lade Phasen
                    if (data.phases) {
                        render(data.phases);
                    }
                }
            };
            reader.readAsText(input.files[0]);
        }

        window.onload = () => {
            const savedTheme = localStorage.getItem('selectedTheme') || 'default';
            setTheme(savedTheme);
            render(defaultData);
        };

        let allMinimized = false;

        function toggleAllModules() {
            const items = document.querySelectorAll('.timeline-item');
            const btn = document.getElementById('toggle-btn');

            allMinimized = !allMinimized;

            items.forEach(item => {
                if (allMinimized) {
                    item.classList.add('minimized');
                } else {
                    item.classList.remove('minimized');
                }
            });

            btn.innerText = allMinimized ? "üìã Alle zeigen" : "üìã √úbersicht";
        }

        function clearTimeline() {
            if (!confirm("Wirklich alles zur√ºcksetzen?")) return;
            render(defaultData);
        }

        // Helper: RGB to HEX
        function rgbToHex(rgb) {
            if (!rgb || rgb.startsWith('#')) return rgb || '#4299e1';
            const match = rgb.match(/\d+/g);
            if (!match) return '#4299e1';
            const r = parseInt(match[0]).toString(16).padStart(2, '0');
            const g = parseInt(match[1]).toString(16).padStart(2, '0');
            const b = parseInt(match[2]).toString(16).padStart(2, '0');
            return `#${r}${g}${b}`;
        }
    </script>

<!-- ===================== SUPABASE AUTH + CLOUD SAVE ===================== -->
<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

  const SUPABASE_URL = 'https://lqrxqwrzuhsaeocppdfm.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxxcnhxd3J6dWhzYWVvY3BwZGZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTA5ODgsImV4cCI6MjA4NDM4Njk4OH0.8Jd74oHNqd6SBd0yHCjhPq7_Opr2jCyszaaG37en-WA';

  const sb = createClient(SUPABASE_URL, SUPABASE_KEY);
  window.sb = sb;

  const overlay = document.getElementById('login-overlay');
  const msgEl = document.getElementById('sb-msg');
  const btnLogin = document.getElementById('sb-btn-login');
  const btnSignup = document.getElementById('sb-btn-signup');
  const btnResend = document.getElementById('sb-btn-resend');

  function setMsg(text, color = '#718096') {
    if (!msgEl) return;
    msgEl.textContent = text;
    msgEl.style.color = color;
  }

  btnLogin?.addEventListener('click', async () => {
    const email = document.getElementById('sb-email')?.value?.trim();
    const password = document.getElementById('sb-password')?.value;
    btnResend && (btnResend.style.display = 'none');
    setMsg('Login...');

    const { error } = await sb.auth.signInWithPassword({ email, password });
    if (error) {
      if (String(error.message).includes('Email not confirmed')) {
        setMsg('E-Mail nicht best√§tigt. Bitte Link in der E-Mail klicken.', '#dd6b20');
        if (btnResend) btnResend.style.display = 'block';
      } else {
        setMsg(error.message, '#e53e3e');
      }
    }
  });

  btnSignup?.addEventListener('click', async () => {
    const email = document.getElementById('sb-email')?.value?.trim();
    const password = document.getElementById('sb-password')?.value;
    btnResend && (btnResend.style.display = 'none');
    setMsg('Registrieren...');

    const emailRedirectTo = window.location.origin + window.location.pathname;

    const { error } = await sb.auth.signUp({
      email,
      password,
      options: { emailRedirectTo }
    });

    if (error) setMsg(error.message, '#e53e3e');
    else setMsg('Best√§tigungs-Mail gesendet. Bitte Postfach (auch Spam) pr√ºfen.', '#2f855a');
  });

  btnResend?.addEventListener('click', async () => {
    const email = document.getElementById('sb-email')?.value?.trim();
    setMsg('Sende Best√§tigungs-Mail erneut...');
    const { error } = await sb.auth.resend({ type: 'signup', email });
    if (error) setMsg(error.message, '#e53e3e');
    else setMsg('Neue Best√§tigungs-Mail wurde gesendet.', '#2f855a');
  });

  sb.auth.onAuthStateChange(async (_event, session) => {
    if (session) {
      if (overlay) overlay.style.display = 'none';
      await window.loadFromCloud?.();
    } else {
      if (overlay) overlay.style.display = 'flex';
    }
  });

  window.saveToCloud = async function saveToCloud() {
    const btn = document.getElementById('btn-cloud-save');
    const old = btn?.textContent;
    if (btn) btn.textContent = '‚è≥ Cloud...';

    const { data: userData } = await sb.auth.getUser();
    const user = userData?.user;
    if (!user) {
      if (btn) btn.textContent = old || '‚òÅÔ∏è Cloud';
      alert('Bitte zuerst einloggen.');
      return;
    }

    const phases = [...document.querySelectorAll('.phase')].map(p => ({
      title: p.querySelector('.phase-title')?.innerText ?? '',
      duration: p.querySelector('.phase-duration')?.innerText ?? '',
      items: [...p.querySelectorAll('.timeline-item')].map(i => ({
        text: i.querySelector('.item-title')?.innerText ?? '',
        description: i.querySelector('.item-description')?.innerText ?? '',
        status: i.querySelector('select')?.value ?? 'todo',
        assignees: [...i.querySelectorAll('.module-avatar')].map(av => av.dataset.id)
      }))
    }));

    const team = [...document.querySelectorAll('#team-container .person-chip')].map(chip => {
      const nameInput = chip.querySelector('.person-name-input');
      const name = (nameInput?.textContent || nameInput?.innerText || '').trim();
      const avatar = chip.querySelector('.person-chip-avatar');
      return { id: chip.dataset.id, name, color: avatar?.style?.backgroundColor || '' };
    });

    const headerNameEl = document.getElementById('header-name');
    const candidateName = (headerNameEl?.textContent || headerNameEl?.innerText || '').trim();
    const currentTheme = localStorage.getItem('selectedTheme') || 'default';

    const fullData = { candidateName, theme: currentTheme, team, phases };

    const { error } = await sb
      .from('user_plans')
      .upsert({ user_id: user.id, plan_data: fullData, updated_at: new Date().toISOString() });

    if (error) {
      console.error(error);
      alert('Cloud Save Fehler: ' + error.message);
      if (btn) btn.textContent = old || '‚òÅÔ∏è Cloud';
    } else {
      if (btn) btn.textContent = '‚úÖ Cloud OK';
      setTimeout(() => { if (btn) btn.textContent = old || '‚òÅÔ∏è Cloud'; }, 1200);
    }
  };

  window.loadFromCloud = async function loadFromCloud() {
    const { data: userData } = await sb.auth.getUser();
    const user = userData?.user;
    if (!user) return;

    const { data, error } = await sb
      .from('user_plans')
      .select('plan_data')
      .eq('user_id', user.id)
      .maybeSingle();

    if (error) return;

    const plan = data?.plan_data;
    if (!plan) return;

    if (plan.theme) {
      try { window.setTheme?.(plan.theme); } catch(_) {}
    }

    if (plan.team && plan.team.length > 0) {
      const teamContainer = document.getElementById('team-container');
      if (teamContainer) {
        teamContainer.innerHTML = '';
        plan.team.forEach(person => {
          const div = document.createElement('div');
          div.className = 'person-chip';
          div.draggable = true;
          div.dataset.id = person.id;
          div.dataset.type = 'person';

          const initial = (person.name || '?').charAt(0).toUpperCase();
          const deleteBtn = person.id === 'main' ? '' : '<span class="person-delete" onclick="deletePerson(this)">√ó</span>';
          const idAttr = person.id === 'main' ? 'id="name-main-sidebar"' : '';

          div.innerHTML = `
            <div class="person-chip-avatar" style="background-color: ${person.color}" onclick="openColorPicker(event, '${person.id}')">${initial}</div>
            <span class="person-name-input" ${idAttr} contenteditable="true" oninput="updatePersonName(this, '${person.id}')">${person.name}</span>
            ${deleteBtn}
          `;
          teamContainer.appendChild(div);
        });
      }
    }

    if (plan.candidateName) {
      const headerName = document.getElementById('header-name');
      if (headerName) headerName.textContent = plan.candidateName;

      const mainNameEl = document.getElementById('name-main-sidebar');
      if (mainNameEl) {
        mainNameEl.textContent = plan.candidateName;
        const mainChip = mainNameEl.closest('.person-chip');
        if (mainChip) {
          const mainAvatar = mainChip.querySelector('.person-chip-avatar');
          if (mainAvatar) mainAvatar.textContent = plan.candidateName.charAt(0).toUpperCase();
        }
      }
    }

    if (plan.phases) {
      try { window.render?.(plan.phases); } catch (_) {}
    }
  };

  window.doLogout = async function doLogout() {
    await sb.auth.signOut();
    if (overlay) overlay.style.display = 'flex';
  };

  const { data: sess } = await sb.auth.getSession();
  if (sess?.session) {
    if (overlay) overlay.style.display = 'none';
    await window.loadFromCloud?.();
  } else {
    if (overlay) overlay.style.display = 'flex';
  }
</script>
<!-- ===================== /SUPABASE AUTH + CLOUD SAVE ===================== -->

</body>
</html>
