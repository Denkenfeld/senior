<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vitakreis Onboarding Planer (Live)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* (Gleiches CSS wie zuvor - hier gekÃ¼rzt fÃ¼r Ãœbersichtlichkeit, fÃ¼ge es bei Bedarf komplett ein) */
        :root { --primary: #2c7a7b; --bg: #f7fafc; --surface: #ffffff; --text: #2d3748; --border: #e2e8f0; --accent: #ed8936; --success: #48bb78; --running: #4299e1; --gray: #a0aec0; --radius: 8px; }
        body { font-family: 'Inter', system-ui, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Basis Layout Styles */
        aside { width: 320px; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        main { flex: 1; display: flex; flex-direction: column; height: 100vh; }
        header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Login Styles */
        #login-screen { position:fixed; top:0; left:0; right:0; bottom:0; background:linear-gradient(135deg, #2c7a7b 0%, #4299e1 100%); z-index:1000; display:flex; align-items:center; justify-content:center; }
        .login-box { max-width:400px; width:90%; padding:40px; background:white; border-radius:12px; box-shadow:0 20px 50px rgba(0,0,0,0.2); }
        .input-field { width:100%; padding:12px; margin:8px 0; border:1px solid #e2e8f0; border-radius:6px; box-sizing:border-box; }
        .btn-primary { width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:6px; margin-top:10px; cursor:pointer; font-weight:bold; }
        .btn-outline { width:100%; padding:12px; background:transparent; color:var(--primary); border:2px solid var(--primary); border-radius:6px; margin-top:10px; cursor:pointer; font-weight:bold; }
        .error-msg { color: #e53e3e; font-size: 0.9rem; margin-top: 10px; display: none; text-align: center;}
        .success-msg { color: #48bb78; font-size: 0.9rem; margin-top: 10px; display: none; text-align: center;}

        /* App Styles simplified for context */
        .timeline-container { padding: 40px; flex: 1; overflow-y: auto; }
        .timeline-item { background: white; border: 1px solid var(--border); margin-bottom: 15px; padding: 15px; border-radius: 8px; }
        
        /* Verstecke App bis Login */
        #app-sidebar, #app-main { display: none; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="text-align:center; color:#2c7a7b; margin-top:0;">VitaKreis</h1>
            
            <div id="login-form">
                <input type="email" id="email" class="input-field" placeholder="E-Mail">
                <input type="password" id="password" class="input-field" placeholder="Passwort">
                <button onclick="handleLogin()" class="btn-primary" id="btn-login">Einloggen</button>
                <button onclick="toggleForms()" style="background:none; border:none; color:#718096; width:100%; margin-top:10px; cursor:pointer; text-decoration:underline;">Noch keinen Account? Registrieren</button>
                <div id="login-error" class="error-msg"></div>
            </div>

            <div id="signup-form" style="display:none;">
                <input type="email" id="reg-email" class="input-field" placeholder="E-Mail">
                <input type="password" id="reg-password" class="input-field" placeholder="Passwort (min. 6 Zeichen)">
                <button onclick="handleSignup()" class="btn-outline" id="btn-signup">Kostenlos Registrieren</button>
                <button onclick="toggleForms()" style="background:none; border:none; color:#718096; width:100%; margin-top:10px; cursor:pointer; text-decoration:underline;">ZurÃ¼ck zum Login</button>
                <div id="signup-error" class="error-msg"></div>
                <div id="signup-success" class="success-msg"></div>
            </div>
        </div>
    </div>

    <aside id="app-sidebar">
        <h2>Planung</h2>
        <div style="margin-top:20px; color:#718096; font-size:0.9rem;">
            Hier ist deine Seitenleiste.<br>
            (Module werden geladen...)
        </div>
        <button onclick="handleLogout()" style="margin-top:auto; padding:10px; background:#e53e3e; color:white; border:none; border-radius:6px; cursor:pointer;">Abmelden</button>
    </aside>

    <main id="app-main">
        <header>
            <h1 id="header-title">Onboarding Plan</h1>
            <div>
                <span id="user-display" style="margin-right:15px; font-size:0.9rem; color:#718096;"></span>
                <button onclick="saveData()" style="padding:8px 16px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer;">ðŸ’¾ Speichern</button>
            </div>
        </header>
        <div id="timeline-canvas" class="timeline-container">
            <div id="content-area">
                <p>Lade Daten...</p>
            </div>
        </div>
    </main>

    <script>
        // ==========================================
        // KONFIGURATION - HIER EINFÃœGEN!
        // ==========================================
        
        // 1. Gehe zu Supabase -> Project Settings -> API
        // 2. Kopiere "Project URL" und "anon public" Key hier rein:
        
        const SUPABASE_URL = 'HIER_DEINE_SUPABASE_URL_EINFUEGEN';
        const SUPABASE_KEY = 'HIER_DEIN_ANON_KEY_EINFUEGEN';

        // ==========================================

        let supabase;
        let currentUser = null;

        // Init Supabase
        try {
            if (!SUPABASE_URL.includes('HIER_DEINE')) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log("Supabase initialisiert");
            } else {
                console.error("BITTE SUPABASE URL UND KEY IM CODE EINTRAGEN!");
                document.getElementById('login-error').innerText = "Konfiguration fehlt im Code (Zeile 108)!";
                document.getElementById('login-error').style.display = "block";
            }
        } catch (e) {
            console.error("Fehler beim Start:", e);
        }

        // Check Session beim Start
        async function init() {
            if(!supabase) return;
            
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                showApp();
            }
        }
        init();

        // UI Umschalter
        function toggleForms() {
            const login = document.getElementById('login-form');
            const signup = document.getElementById('signup-form');
            if (login.style.display === 'none') {
                login.style.display = 'block';
                signup.style.display = 'none';
            } else {
                login.style.display = 'none';
                signup.style.display = 'block';
            }
        }

        function showApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-sidebar').style.display = 'flex';
            document.getElementById('app-main').style.display = 'flex';
            document.getElementById('user-display').innerText = currentUser.email;
            loadData();
        }

        // ------------------------------------------
        // AUTHENTIFIZIERUNG
        // ------------------------------------------

        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errDiv = document.getElementById('login-error');
            const btn = document.getElementById('btn-login');

            errDiv.style.display = 'none';
            btn.innerText = "Lade...";

            const { data, error } = await supabase.auth.signInWithPassword({
                email, password
            });

            btn.innerText = "Einloggen";

            if (error) {
                errDiv.innerText = "Fehler: " + error.message;
                errDiv.style.display = 'block';
            } else {
                currentUser = data.user;
                showApp();
            }
        }

        async function handleSignup() {
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const errDiv = document.getElementById('signup-error');
            const succDiv = document.getElementById('signup-success');
            const btn = document.getElementById('btn-signup');

            errDiv.style.display = 'none';
            succDiv.style.display = 'none';
            btn.innerText = "Registriere...";

            const { data, error } = await supabase.auth.signUp({
                email, password
            });

            btn.innerText = "Kostenlos Registrieren";

            if (error) {
                errDiv.innerText = "Fehler: " + error.message;
                errDiv.style.display = 'block';
            } else {
                succDiv.innerHTML = "Account erstellt! <br>Bitte bestÃ¤tige deine E-Mail (falls aktiviert) oder logge dich ein.";
                succDiv.style.display = 'block';
                // Automatischer Login Versuch
                setTimeout(() => {
                    toggleForms();
                    document.getElementById('email').value = email;
                    document.getElementById('password').value = password;
                }, 2000);
            }
        }

        async function handleLogout() {
            await supabase.auth.signOut();
            window.location.reload();
        }

        // ------------------------------------------
        // DATENBANK (LADEN & SPEICHERN)
        // ------------------------------------------

        // Beispiel-Daten Struktur (wÃ¼rde normalerweise aus dem komplexen Code kommen)
        const defaultData = {
            candidate_name: "Neuer Kandidat",
            phases: [{ title: "Willkommen", items: [] }],
            theme: "default"
        };

        async function loadData() {
            const content = document.getElementById('content-area');
            content.innerHTML = "Lade Daten aus Supabase...";

            // SELECT Abfrage
            const { data, error } = await supabase
                .from('onboarding_plans')
                .select('*')
                .eq('user_id', currentUser.id)
                .maybeSingle(); // maybeSingle verhindert Fehler wenn noch keine Daten da sind

            if (error) {
                console.error("Ladefehler:", error);
                content.innerHTML = `<div style="color:red">Fehler beim Laden: ${error.message}</div>`;
                return;
            }

            if (!data) {
                console.log("Keine Daten gefunden, lade Standard.");
                renderData(defaultData);
            } else {
                console.log("Daten geladen:", data);
                renderData(data);
            }
        }

        async function saveData() {
            // Hier simulieren wir das Sammeln der Daten aus der UI
            // In deinem vollen Code ist das die Funktion collectCurrentData()
            const dataToSave = {
                user_id: currentUser.id,
                candidate_name: document.querySelector('#header-title').innerText,
                phases: [{ title: "Beispiel Phase", items: ["Item 1", "Item 2"] }], // Dummy Daten
                updated_at: new Date().toISOString()
            };

            const { error } = await supabase
                .from('onboarding_plans')
                .upsert(dataToSave, { onConflict: 'user_id' });

            if (error) {
                alert("Fehler beim Speichern: " + error.message);
                console.error(error);
            } else {
                alert("âœ… Daten erfolgreich in der Cloud gespeichert!");
            }
        }

        function renderData(data) {
            const content = document.getElementById('content-area');
            // Einfache Anzeige zu Testzwecken
            content.innerHTML = `
                <h3>Willkommen, ${data.candidate_name || 'User'}</h3>
                <p>Status: Verbunden mit Supabase âœ…</p>
                <p>Wenn du auf "Speichern" klickst, wird ein Test-Datensatz in deine Tabelle geschrieben.</p>
                <pre style="background:#eee; padding:10px; border-radius:5px;">${JSON.stringify(data, null, 2)}</pre>
            `;
            if(data.candidate_name) document.querySelector('#header-title').innerText = data.candidate_name;
        }

    </script>
</body>
</html>
